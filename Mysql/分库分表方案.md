##### 非partition key跨库跨表分页查询问题(水平分库分表，拆分策略为常用的hash法)

**使用NOSQL法解决** ????? 怎么做的

##### 扩容问题(水平分库分表，拆分策略为常用的hash法)

1. 水平扩容库(升级从库法)   成倍扩容

   原本的系统为，多库，每个库都有一主一从，首先通过映射关系，将原来的数据rehash，映射到主从的多个库中，这个时候把从库也当成主库对待。结束该步骤之后，备库升级为主库，添加新的主备同步关系，删除冗余数据，。这个可以保证不停机扩容。。。

2.  水平扩容表(双写迁移法)   

   同步双写； 异步双写可以引入MQ作为中间件，老库中的数据先写入MQ中，异步写入新表

   应用配置双写，部署

   将老库中的老数据复制到新库中

   以老库为校准，对新库中的老数据进行校准

   应用去掉双写，部署

**双写是通用方案**

#### 分库分表总结

- 分库分表，首先检测瓶颈，才可以合理的拆分（分库或者分表，水平还是垂直）
- 选择key很重要，既要考虑到拆分均匀，也要考虑到非partition key的查询
- 只要能满足需求，拆分规则越简单越好

### Mysql分库分表方案

#### 数据库瓶颈

##### IO瓶颈

- IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度  **分库和垂直分表。**
- 网络IO瓶颈，请求的数据太多，网络太宽不够。 **分库**

##### CPU瓶颈

- sql语句包含join等非索引字段条件查询，增加CPU运算的操作  **建立索引**
- 单标数据量太大，查询时扫描的行太多，sql效率低，CPU出现瓶颈  **水平分表**

#### 分库分表

##### 水平分库

- 通过主键哈希映射到不同分库中
- 根据数据来源分库 例如订单来源
- 概念：以字段为依据，按照一定策略（hash，range）分多个库，每个库结构相同，数据无交集。
- 场景：系统绝对并发量高，分表难以根本解决问题
- 分析：库多了，io和cpu的压力可缓解

##### 水平分表

- 概念：与分库类似
- 场景：系统绝对并发量不高，但是单表数据量巨大，影响sql效率
- 分析：表的数量啥了，单词sql执行效率高

##### 垂直分库

- 概念：以表为依据，按照业务归属不同，将不同的表拆分到不同的库中；每个库结构不同，数据无交集
- 场景：系统绝对并发量高，并且可以抽象出单独的业务模块
- 分析：可以进行服务化。具体应该是指根据业务模块，发展处一套自己单独的库

##### 垂直分表

- 概念：以字段为依据，按照字段的活跃性，将表中字段拆到不同的表中
- 场景：系统绝对并发量不高，表的记录并不多，但是字段多，并且热点数据和非热点数据在一起，单行数据所需的存储空间比较大。以至于数据库缓存的数据行减少，查询时会去读磁盘数据产生大量的随机读IO，产生IO瓶颈。
- 分析：可以将热点数据放在一起作为主表，非热点数据作为扩展表。这样更多的热点数据就能被缓存下来，减少了随机IO。拆分之后想要获取全部数据，需要关联多表，不要用join，因为join会增加CPU负担会将两个表耦合在一起。关联数据，应该在service上处理，分别获取主表和扩展表，然后用关联字段关联到所有数据

#### 分库分表工具

- sharding-sphere(sharding-jdbc)
- Mycat

#### 分库分表步骤

- 测算容量 当前容量和增长量，评估分库或分表个数
- 选择key，时结果均匀
- 确定分表规则 hash或者range
- 双写一致性
- **扩容问题**   

#### 分库分表问题

##### 非partition key的查询问题(水平分库分表，拆分策略为常用的hash法)

**端上除了partition key只有一个非partition key 作为条件查询**

- 映射法

关于映射表：

1. 索引覆盖查询，很快；
2. 分布式索引缓存映射，比表绝对快，不过要保证高可用，不要被穿透，为了绝对可靠可以表和缓存l联用

- 基因法

  写入时，即引发生成id，关于xbit基因，列入要分8张表，，3bit基因。根据id查询时可直接取模，路由到对应的分库或者分表。根据那么查询时，先通过生成函数生成字段，在对其取模，路由到对应的分库或者分表，id生成使用雪花算法

**端上除了partition key 不止一个非partition key作为条件查询**

- 映射法

  所理解的就是，将多个字段联合做为表中字段，生成一个唯一id，进行映射分库

- 冗余法

  没看懂的方法

**后台除了partition key还有各种非partition key组合条件查询**

略略略

[分库分表方案](https://www.cnblogs.com/littlecharacter/p/9342129.html)

[分库分表示例](https://github.com/littlecharacter4s/study-sharding)





​	



