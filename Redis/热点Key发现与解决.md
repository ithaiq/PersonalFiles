#### Redis热key问题

##### 热点问题造成原因

- 用户消费的数据远远大于生产的数据
- 热卖商品，热卖新闻，热点评论
- 请求分片集中，单Server性能极限

##### 热点问题实际案例

- 知乎微博等，大多数只是浏览，并不会去提问问题，发表文章，这就是一个典型的读多写少的情景，此类情景不太容易导致热点问题。
- 日常工作中一些突发事件，诸如双十一，其中某些商品被数万次点击，会形成一个较大的需求量，这种情况会产生单一key的热点问题；同理，热点新闻和文章被同时多次浏览，也会产生热点。
- 在服务端读数据进行访问的时，往往会对数据进行分片切分，该过程中会产生某一主机Server上对于相应的Key进行访问，当访问超过主机极限时，产生热点key问题

##### 为什么要解决热点key问题

- 流量集中，达到物理网卡上限，导致服务器中其他服务无法正常进行
- 请求过多，缓存分片服务被打垮
- 缓存击穿，请求穿透，引起雪崩
  - 热点key缓存过多，超过目前的缓存容量时，就对导致缓存分片服务被打垮现象产生。当缓存服务崩溃时，此时请求会打在DB服务上，在面临大请求时很容易发生请求穿透现象。

##### 常见问题解决方案

###### 	服务端缓存方案

​	首先Client会将请求发送至Server，而Server是一个多线程服务，本地就具有一个小的缓存空间。当Server本身拥堵时，server不会将请求进一步发送DB而是直接返回，只有当S本身畅通时才会将C请求发送至DB，并且将数据重新写入Cache中。

​	此时就完成了缓存的访问跟重建，但是方案有一定的缺陷

- 缓存失效，多线程构建缓存的问题
- 缓存丢失，缓存构建问题
- 脏读问题

###### 使用Memcache，Redis方案

​	该方法通过在C端单独部署缓存的方式来解决热点问题，使用过程中C首先访问服务层，再对同一主机的缓存层进行访问。优点和造成的问题

- 就近访问，速度快
- 内存资源浪费
- 脏读问题

##### 阿里云数据库解热点问题

###### **读写分离方案**

**架构中节点作用**

- SLB负载均衡
- Proxy做读写分离自动路由
- Master负责写
- readOnly节点负责读请求
- slave节点和Master节点做高可用

​       实际过程中C将请求传到SLB，SLB又将其分发到多个Proxy内，通过Proxy对请求的识别，将其进行分类发送。将write发到master，将read发到只读模块，而模块中的节点具有可以进一步扩展的优点，可以有效解决热点问题多的问题。读写分离同时具有可以灵活扩容读热点能力，可以存储大量热点key和对客户端友好的优势。

###### **热点数据解决方案**

​		和读写方案有所不同，该方案通过主动发现热点并对其进行存储来解决热点key的问题。首先客户端也会访问SLB，并且通过SLB将各种请求分发到Proxy中，Proxy按照基于路由的方式将请求换发至后端Redis中。	

​		在热点Key的解决上，是采用在服务端增加缓存的方式进行。具体来说就是在Proxy上增加本地缓存，本地缓存采用LRU算法来缓存热点数据，后端DB节点增加热点数据计算模块来返回热点数据。

**Proxy架构的优势**

- Proxy缓存热点，读能力可以水平扩展
- DB自动计算热点Key
- 对客户端完全透明，不需要任何兼容

**DB计算并发现热点，方法和优势**

- 基于统计阈值
- 基于周期热点统计

##### **热点数据的读取**

​		在热点Key的处理上主要分为读写两种，在数据k写入SLB时，通过Proxy路由，写入某一个Redis，完成数据写入，经过计算，k成为热点数据，Proxy会将该k缓存到Proxy层，当客户单再次访问时，可以不需要经过redis，并且，Proxy可以任意水平扩展，所以热点数据的读能力可以极大提升。

##### **热点数据发现**

​	对于DB层热点数据的发现，首先会在一个周期内对Key进行请求统计，在达到请求量级后，会对热点Key进行热点定位，并将所有的热点Key放入一个小的LRU链表内，在通过PRoxy请求进行访问时，若Redis发现待访问是一个热点，就会进入一个反馈阶段，对这个数据进行标记

通过上述对比分析，阿里云在解决热点Key上读写分离方案和热点数据解决方案都有灵活的水平扩展能力，都有一定的数据不一致性。



[热点Key的发现和解决](https://yq.aliyun.com/articles/404817)